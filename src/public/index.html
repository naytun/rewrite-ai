<!DOCTYPE html>
<html lang="en" class="light">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Novel Library</title>
		<link
			href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
			rel="stylesheet"
		/>
		<style>
			/* Basic styles */
			body {
				margin: 0;
				padding: 0;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
					sans-serif;
				background: #f3f4f6;
			}

			/* Dark mode styles */
			html.dark body {
				background-color: #1a1a1a;
				color: #ffffff;
			}

			/* Container styles */
			.container {
				max-width: 1200px;
				margin: 0 auto;
				padding: 0 15px;
			}

			/* Header styles */
			.header {
				padding: 20px 0;
				margin-bottom: 30px;
			}

			.header-content {
				display: table;
				width: 100%;
			}

			.header-title {
				display: table-cell;
				vertical-align: middle;
				font-size: 24px;
				font-weight: bold;
			}

			.header-controls {
				display: table-cell;
				vertical-align: middle;
				text-align: right;
			}

			/* Toggle switch styles */
			.toggle-container {
				display: inline-block;
				margin-right: 20px;
				vertical-align: middle;
			}

			.toggle-label {
				margin-right: 8px;
				vertical-align: middle;
			}

			.toggle-switch {
				position: relative;
				display: inline-block;
				width: 48px;
				height: 24px;
				vertical-align: middle;
			}

			.toggle-switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}

			.toggle-slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				border-radius: 24px;
				transition: 0.4s;
			}

			.toggle-slider:before {
				position: absolute;
				content: '';
				height: 18px;
				width: 18px;
				left: 3px;
				bottom: 3px;
				background-color: white;
				border-radius: 50%;
				transition: 0.4s;
			}

			input:checked + .toggle-slider {
				background-color: #3b82f6;
			}

			input:checked + .toggle-slider:before {
				transform: translateX(24px);
			}

			/* Settings button */
			.settings-btn {
				display: inline-block;
				padding: 8px 16px;
				background-color: #3b82f6;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				vertical-align: middle;
			}

			/* Novels grid */
			#novels {
				text-align: center;
				font-size: 0; /* Remove space between inline-block elements */
			}

			.novel-card {
				display: inline-block;
				vertical-align: top;
				width: 280px;
				margin: 10px;
				background: white;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				text-align: left;
				font-size: 16px; /* Reset font size */
			}

			.novel-image {
				position: relative;
				width: 100%;
				height: 0;
				padding-bottom: 133.33%;
				overflow: hidden;
				background: #f5f5f5;
				border-radius: 8px 8px 0 0;
			}

			.novel-image img {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			.novel-content {
				padding: 15px;
			}

			.novel-title {
				font-size: 18px;
				font-weight: bold;
				margin: 0 0 10px 0;
				overflow: hidden;
				text-overflow: ellipsis;
				display: -webkit-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				max-height: 2.4em;
			}

			.novel-title a {
				color: inherit;
				text-decoration: none;
			}

			.novel-author {
				font-size: 14px;
				color: #666;
				margin-bottom: 10px;
			}

			.novel-chapter {
				font-size: 14px;
				color: #666;
			}

			.novel-chapter a {
				color: inherit;
				text-decoration: none;
			}

			.bookmark-icon {
				display: inline-block;
				width: 14px;
				height: 14px;
				margin-left: 4px;
				vertical-align: middle;
				fill: #f97316;
			}

			/* Loading and error states */
			#loading,
			#error {
				text-align: center;
				padding: 20px;
				font-size: 16px;
			}

			#error {
				color: #dc2626;
				display: none;
			}

			/* Settings Modal */
			#settingsModal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0, 0, 0, 0.5);
				z-index: 1000;
			}

			#settingsModal.visible {
				display: block;
			}

			.modal-content {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: white;
				padding: 20px;
				border-radius: 8px;
				width: 90%;
				max-width: 500px;
			}

			.modal-header {
				margin-bottom: 15px;
			}

			.modal-close {
				float: right;
				background: none;
				border: none;
				font-size: 24px;
				cursor: pointer;
				padding: 0;
				margin: 0;
			}

			.modal-textarea {
				width: 100%;
				min-height: 150px;
				margin-bottom: 15px;
				padding: 8px;
				border: 1px solid #ccc;
				border-radius: 4px;
				resize: vertical;
			}

			.modal-save {
				float: right;
				padding: 8px 16px;
				background: #3b82f6;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
			}

			/* Dark mode overrides */
			html.dark .novel-card {
				background: #2d2d2d;
			}

			html.dark .novel-author,
			html.dark .novel-chapter {
				color: #999;
			}

			html.dark .modal-content {
				background: #2d2d2d;
				color: white;
			}

			html.dark .modal-textarea {
				background: #1a1a1a;
				border-color: #444;
				color: white;
			}

			/* Media queries */
			@media (max-width: 640px) {
				.novel-card {
					width: calc(100% - 20px);
					margin: 10px;
				}

				.header-content {
					display: block;
				}

				.header-title {
					display: block;
					text-align: center;
					margin-bottom: 15px;
				}

				.header-controls {
					display: block;
					text-align: center;
				}

				.toggle-container {
					display: block;
					margin: 10px 0;
				}
			}

			@media (min-width: 641px) and (max-width: 1024px) {
				.novel-card {
					width: calc(50% - 20px);
				}
			}

			@media (min-width: 1025px) {
				.novel-card {
					width: calc(33.333% - 20px);
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header class="header">
				<div class="header-content">
					<div class="header-title">Novel Library</div>
					<div class="header-controls">
						<div class="toggle-container">
							<span class="toggle-label">AI Rewrite</span>
							<label class="toggle-switch">
								<input type="checkbox" id="aiToggle" />
								<span class="toggle-slider"></span>
							</label>
						</div>
						<div class="toggle-container">
							<span class="toggle-label">Dark Mode</span>
							<label class="toggle-switch">
								<input type="checkbox" id="darkModeToggle" />
								<span class="toggle-slider"></span>
							</label>
						</div>
						<button id="settingsBtn" class="settings-btn">
							<i class="fas fa-cog"></i> AI Settings
						</button>
					</div>
				</div>
			</header>

			<div id="loading">Loading novels...</div>
			<div id="error"></div>
			<div id="novels"></div>
		</div>

		<!-- Settings Modal -->
		<div id="settingsModal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>AI Settings</h2>
					<button id="closeSettingsBtn" class="modal-close">&times;</button>
				</div>
				<div>
					<textarea
						id="aiPrompt"
						class="modal-textarea"
						placeholder="Enter instructions for how the AI should rewrite the novel content..."
					></textarea>
				</div>
				<div>
					<button id="saveSettingsBtn" class="modal-save">Save</button>
				</div>
			</div>
		</div>

		<script>
			// Dark mode and AI mode functionality
			var darkModeToggle = document.getElementById('darkModeToggle')
			var aiToggle = document.getElementById('aiToggle')

			// Check for saved preferences
			if (localStorage.getItem('darkMode') === 'true') {
				document.documentElement.classList.add('dark')
				darkModeToggle.checked = true
			}

			if (localStorage.getItem('aiRewrite') === 'true') {
				aiToggle.checked = true
			}

			// Toggle dark mode
			darkModeToggle.onclick = function () {
				var isDark = darkModeToggle.checked
				if (isDark) {
					document.documentElement.classList.add('dark')
					localStorage.setItem('darkMode', 'true')
				} else {
					document.documentElement.classList.remove('dark')
					localStorage.setItem('darkMode', 'false')
				}
			}

			// Toggle AI mode
			aiToggle.onclick = function () {
				var isEnabled = aiToggle.checked
				localStorage.setItem('aiRewrite', isEnabled.toString())

				var xhr = new XMLHttpRequest()
				xhr.open('POST', '/api/settings/ai-rewrite', true)
				xhr.setRequestHeader('Content-Type', 'application/json')
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							try {
								var result = JSON.parse(xhr.responseText)
								if (result.enabled !== isEnabled) {
									aiToggle.checked = result.enabled
								}
								window.location.reload()
							} catch (error) {
								console.error('Error parsing response:', error)
								aiToggle.checked = !isEnabled
								localStorage.setItem('aiRewrite', (!isEnabled).toString())
							}
						} else {
							console.error('Failed to update AI settings')
							aiToggle.checked = !isEnabled
							localStorage.setItem('aiRewrite', (!isEnabled).toString())
						}
					}
				}

				xhr.send(JSON.stringify({ enabled: isEnabled }))
			}

			// Load novels
			function loadNovels() {
				var loadingEl = document.getElementById('loading')
				var errorEl = document.getElementById('error')
				var novelsContainer = document.getElementById('novels')

				loadingEl.style.display = 'block'
				errorEl.style.display = 'none'
				novelsContainer.innerHTML = ''

				var xhr = new XMLHttpRequest()
				xhr.open('GET', '/api/novel/novels', true)
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4) {
						loadingEl.style.display = 'none'

						if (xhr.status === 200) {
							try {
								var novels = JSON.parse(xhr.responseText)
								if (!novels || !novels.length) {
									showError('No novels found')
									return
								}

								for (var i = 0; i < novels.length; i++) {
									var card = createNovelCard(novels[i])
									if (card) {
										novelsContainer.appendChild(card)
									}
								}
							} catch (error) {
								showError('Error loading novels: Invalid data')
							}
						} else {
							showError('Error loading novels: Server error')
						}
					}
				}

				xhr.send(null)
			}

			function createNovelCard(novel) {
				if (!novel || !novel.id || !novel.title) return null

				var card = document.createElement('div')
				card.className = 'novel-card'

				var lastChapter =
					localStorage.getItem('lastChapter_' + novel.id) || 'Not started'
				var coverUrl = novel.cover_url || '/placeholder.jpg'
				var authors =
					novel.authors && novel.authors.length
						? novel.authors.join(', ')
						: 'Unknown'

				card.innerHTML =
					'<div class="novel-image">' +
					'<img src="' +
					coverUrl +
					'" alt="Cover" onerror="this.src=\'/placeholder.jpg\'">' +
					'</div>' +
					'<div class="novel-content">' +
					'<div class="novel-title">' +
					'<a href="/api/novel/novels/' +
					novel.id +
					'/chapters">' +
					novel.title +
					'</a>' +
					'</div>' +
					'<div class="novel-author">Author: ' +
					authors +
					'</div>' +
					'<div class="novel-chapter">' +
					'<a href="#" class="last-chapter-link" data-novel-id="' +
					novel.id +
					'">' +
					'Chapter ' +
					lastChapter +
					'<svg class="bookmark-icon" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg>' +
					'</a>' +
					'</div>' +
					'</div>'

				var links = card.getElementsByClassName('last-chapter-link')
				for (var i = 0; i < links.length; i++) {
					links[i].onclick = function (e) {
						e.preventDefault()
						handleLastChapterClick(this.getAttribute('data-novel-id'))
					}
				}

				return card
			}

			function handleLastChapterClick(novelId) {
				var lastChapter = localStorage.getItem('lastChapter_' + novelId)
				var lastVolume = localStorage.getItem('lastVolume_' + novelId)
				var url = '/api/novel/novels/' + novelId + '/chapters'

				var xhr = new XMLHttpRequest()
				xhr.open('GET', '/api/settings/ai-rewrite', true)
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							try {
								var settings = JSON.parse(xhr.responseText)
								var aiParam = settings.enabled ? '?useAI=true' : ''

								if (lastChapter && lastVolume) {
									window.location.href =
										'/api/novel/novels/' +
										novelId +
										'/chapters/' +
										encodeURIComponent(lastVolume) +
										'/' +
										encodeURIComponent(lastChapter) +
										aiParam
								} else {
									loadFirstChapter(novelId, aiParam)
								}
							} catch (error) {
								console.error('Error parsing AI settings:', error)
								window.location.href = url
							}
						} else {
							window.location.href = url
						}
					}
				}

				xhr.send(null)
			}

			function loadFirstChapter(novelId, aiParam) {
				var xhr = new XMLHttpRequest()
				xhr.open('GET', '/api/novel/novels/' + novelId + '/chapters', true)
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							try {
								var data = JSON.parse(xhr.responseText)
								if (data.chapters && data.chapters.length > 0) {
									var firstChapter = data.chapters[0]
									window.location.href =
										'/api/novel/novels/' +
										novelId +
										'/chapters/' +
										encodeURIComponent(firstChapter.volume) +
										'/' +
										encodeURIComponent(firstChapter.chapter) +
										aiParam
								} else {
									window.location.href =
										'/api/novel/novels/' + novelId + '/chapters'
								}
							} catch (error) {
								console.error('Error parsing chapters:', error)
								window.location.href =
									'/api/novel/novels/' + novelId + '/chapters'
							}
						} else {
							window.location.href =
								'/api/novel/novels/' + novelId + '/chapters'
						}
					}
				}

				xhr.send(null)
			}

			function showError(message) {
				var errorEl = document.getElementById('error')
				errorEl.textContent = message
				errorEl.style.display = 'block'
			}

			// Settings Modal
			var settingsModal = document.getElementById('settingsModal')
			var settingsBtn = document.getElementById('settingsBtn')
			var closeSettingsBtn = document.getElementById('closeSettingsBtn')
			var saveSettingsBtn = document.getElementById('saveSettingsBtn')
			var aiPromptTextarea = document.getElementById('aiPrompt')

			settingsBtn.onclick = function () {
				settingsModal.className = 'visible'
				loadSettings()
			}

			closeSettingsBtn.onclick = function () {
				settingsModal.className = ''
			}

			function loadSettings() {
				var xhr = new XMLHttpRequest()
				xhr.open('GET', '/api/settings/ai-rewrite', true)
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4 && xhr.status === 200) {
						try {
							var settings = JSON.parse(xhr.responseText)
							aiPromptTextarea.value = settings.prompt || ''
							aiToggle.checked = settings.enabled
						} catch (error) {
							console.error('Error loading settings:', error)
						}
					}
				}

				xhr.send(null)
			}

			saveSettingsBtn.onclick = function () {
				var xhr = new XMLHttpRequest()
				xhr.open('POST', '/api/settings/ai-rewrite', true)
				xhr.setRequestHeader('Content-Type', 'application/json')

				xhr.onreadystatechange = function () {
					if (xhr.readyState === 4) {
						if (xhr.status === 200) {
							settingsModal.className = ''
						} else {
							console.error('Failed to save settings')
						}
					}
				}

				xhr.send(
					JSON.stringify({
						enabled: aiToggle.checked,
						prompt: aiPromptTextarea.value,
					})
				)
			}

			window.onclick = function (e) {
				if (e.target === settingsModal) {
					settingsModal.className = ''
				}
			}

			// Load novels when page loads
			window.onload = loadNovels
		</script>
	</body>
</html>
