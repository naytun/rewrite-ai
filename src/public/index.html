<!DOCTYPE html>
<html lang="en" class="light">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Novel Library</title>
		<link
			href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
			rel="stylesheet"
		/>
		<style>
			/* Dark mode styles */
			html.dark body {
				background-color: #1a1a1a;
				color: #ffffff;
			}
			html.dark .bg-white {
				background-color: #2d2d2d;
			}
			html.dark .text-gray-600 {
				color: #d1d1d1;
			}
			.custom-shadow {
				box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
			}
			html.dark .custom-shadow {
				box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
			}
			html.dark footer {
				background-color: rgba(17, 17, 17, 0.7);
			}

			/* Toggle switch custom styles */
			.toggle-switch {
				position: relative;
				display: inline-block;
				width: 48px;
				height: 24px;
			}
			.toggle-switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			.toggle-slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				transition: 0.4s;
				border-radius: 24px;
			}
			.toggle-slider:before {
				position: absolute;
				content: '';
				height: 18px;
				width: 18px;
				left: 3px;
				bottom: 3px;
				background-color: white;
				transition: 0.4s;
				border-radius: 50%;
			}
			input:checked + .toggle-slider {
				background-color: #3b82f6;
			}
			input:checked + .toggle-slider:before {
				transform: translateX(24px);
			}
			.toggle-label {
				font-size: 1rem;
				color: #4b5563;
				margin-right: 8px;
			}
			html.dark .toggle-label {
				color: #e5e7eb;
			}

			/* Ensure minimum height for content */
			html,
			body {
				height: 100%;
				margin: 0;
			}

			/* Settings Modal Dark Mode */
			html.dark .settings-modal-content {
				background-color: #1a1a1a;
				color: #e5e7eb;
			}
			html.dark .settings-modal-textarea {
				background-color: #374151;
				border-color: #4b5563;
				color: #e5e7eb;
				line-height: 1.5rem;
			}
			html.dark .settings-modal-textarea::placeholder {
				color: #9ca3af;
			}
			html.dark .settings-modal-label {
				color: #e5e7eb;
			}
			html.dark .settings-modal-close {
				color: #9ca3af;
			}
			html.dark .settings-modal-close:hover {
				color: #e5e7eb;
			}

			/* Add or update these styles */
			.original-text {
				display: none;
				color: #808080;
				font-style: italic;
				margin-left: 2em;
			}
			.compare-mode .original-text {
				display: block !important;
			}
			.paragraph-pair {
				margin-bottom: 1.5rem;
			}
			.ai-text {
				margin-bottom: 0.5rem;
			}
			.compare-button {
				position: fixed;
				bottom: 80px;
				right: 20px;
				width: 56px;
				height: 56px;
				border-radius: 50%;
				background-color: #9ca3af;
				color: white;
				display: none;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
				transition: all 0.3s ease;
				z-index: 100;
			}
			.compare-button.show {
				display: flex;
			}
			.compare-button.active {
				background-color: #3b82f6;
			}
			.compare-button:hover {
				transform: scale(1.1);
			}
			html.dark .compare-button {
				background-color: #4b5563;
			}
			html.dark .compare-button.active {
				background-color: #3b82f6;
			}

			/* Add novel cover image styles */
			.novel-cover {
				position: relative;
				width: 100%;
				padding-top: 133.33%; /* 3:4 aspect ratio */
				overflow: hidden;
			}
			.novel-cover img {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			/* Mobile-first base styles */
			#novels {
				display: block;
				width: 100%;
				max-width: 1200px;
				margin: 0 auto;
				padding: 0 1rem;
			}

			#novels > div {
				width: 100%;
				max-width: 300px;
				margin: 1rem auto;
				background: #fff;
				border-radius: 8px;
				-webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				overflow: hidden;
				height: auto;
				min-height: 450px;
			}

			/* Tablet and up styles */
			@media (min-width: 768px) {
				#novels {
					display: -webkit-box;
					display: -webkit-flex;
					display: -ms-flexbox;
					display: flex;
					-webkit-flex-wrap: wrap;
					-ms-flex-wrap: wrap;
					flex-wrap: wrap;
					-webkit-box-pack: center;
					-webkit-justify-content: center;
					-ms-flex-pack: center;
					justify-content: center;
					gap: 1rem;
					width: 95%;
				}

				#novels > div {
					-webkit-box-flex: 0;
					-webkit-flex: 0 0 auto;
					-ms-flex: 0 0 auto;
					flex: 0 0 auto;
					width: calc(50% - 1rem);
					max-width: 300px;
					margin: 0.5rem;
				}
			}

			/* iPad mini specific styles */
			@media (min-width: 768px) and (max-width: 820px) {
				#novels > div {
					width: calc(33.333% - 1rem);
				}
			}

			/* Desktop styles */
			@media (min-width: 1024px) {
				#novels > div {
					width: calc(25% - 1rem);
				}
			}

			@media (min-width: 1280px) {
				#novels > div {
					width: calc(20% - 1rem);
				}
			}

			/* Novel card image container */
			.novel-image-container {
				position: relative;
				width: 100%;
				padding-bottom: 133.33%;
				overflow: hidden;
			}

			.novel-image-container img {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				-o-object-fit: cover;
				object-fit: cover;
				-webkit-backface-visibility: hidden;
				backface-visibility: hidden;
			}

			/* Card content styles */
			.novel-content {
				padding: 1rem;
				-webkit-box-flex: 1;
				-webkit-flex: 1;
				-ms-flex: 1;
				flex: 1;
				display: -webkit-box;
				display: -webkit-flex;
				display: -ms-flexbox;
				display: flex;
				-webkit-box-orient: vertical;
				-webkit-box-direction: normal;
				-webkit-flex-direction: column;
				-ms-flex-direction: column;
				flex-direction: column;
			}

			/* Fix for older Safari flex issues */
			.flex {
				display: -webkit-box;
				display: -webkit-flex;
				display: -ms-flexbox;
				display: flex;
			}

			.flex-col {
				-webkit-box-orient: vertical;
				-webkit-box-direction: normal;
				-webkit-flex-direction: column;
				-ms-flex-direction: column;
				flex-direction: column;
			}

			.items-center {
				-webkit-box-align: center;
				-webkit-align-items: center;
				-ms-flex-align: center;
				align-items: center;
			}

			.justify-between {
				-webkit-box-pack: justify;
				-webkit-justify-content: space-between;
				-ms-flex-pack: justify;
				justify-content: space-between;
			}

			/* Glossary modal styles */
			#glossaryModal {
				overflow: hidden;
			}

			#glossaryModal > div {
				max-height: 50vh !important;
				height: auto !important;
			}

			#glossaryContent {
				max-height: calc(50vh - 4rem) !important;
				overflow-y: auto;
				scrollbar-width: thin;
				scrollbar-color: #888 #f1f1f1;
			}

			#glossaryContent::-webkit-scrollbar {
				width: 8px;
			}

			#glossaryContent::-webkit-scrollbar-track {
				background: #f1f1f1;
				border-radius: 4px;
			}

			#glossaryContent::-webkit-scrollbar-thumb {
				background: #888;
				border-radius: 4px;
			}

			#glossaryContent::-webkit-scrollbar-thumb:hover {
				background: #555;
			}

			html.dark #glossaryContent {
				scrollbar-color: #4a5568 #2d3748;
			}

			html.dark #glossaryContent::-webkit-scrollbar-track {
				background: #2d3748;
			}

			html.dark #glossaryContent::-webkit-scrollbar-thumb {
				background: #4a5568;
			}

			html.dark #glossaryContent::-webkit-scrollbar-thumb:hover {
				background: #718096;
			}

			/* Glossary content styles */
			#glossaryContent .mb-6:last-child {
				margin-bottom: 0;
			}

			#glossaryContent .grid {
				gap: 1rem;
			}

			#glossaryContent .p-2 {
				transition: all 0.2s ease-in-out;
			}

			#glossaryContent .p-2:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
					0 2px 4px -1px rgba(0, 0, 0, 0.06);
			}

			html.dark #glossaryContent .p-2:hover {
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3),
					0 2px 4px -1px rgba(0, 0, 0, 0.18);
			}

			/* Settings Modal Styles */
			.modal-overlay {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.5);
				display: none;
				-webkit-box-align: center;
				-webkit-align-items: center;
				-ms-flex-align: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				-ms-flex-pack: center;
				justify-content: center;
				z-index: 1000;
			}

			.modal-overlay.visible {
				display: -webkit-box;
				display: -webkit-flex;
				display: -ms-flexbox;
				display: flex;
			}

			.modal-content {
				background: #fff;
				padding: 1.5rem;
				border-radius: 0.5rem;
				width: 90%;
				max-width: 600px;
				position: relative;
				max-height: 90vh;
				overflow-y: auto;
			}

			html.dark .modal-content {
				background: #1a1a1a;
				color: #fff;
			}

			.modal-header {
				display: -webkit-box;
				display: -webkit-flex;
				display: -ms-flexbox;
				display: flex;
				-webkit-box-pack: justify;
				-webkit-justify-content: space-between;
				-ms-flex-pack: justify;
				justify-content: space-between;
				-webkit-box-align: center;
				-webkit-align-items: center;
				-ms-flex-align: center;
				align-items: center;
				margin-bottom: 1rem;
			}

			.modal-close {
				background: none;
				border: none;
				font-size: 1.5rem;
				cursor: pointer;
				padding: 0.5rem;
				color: #666;
			}

			html.dark .modal-close {
				color: #999;
			}

			.modal-textarea {
				width: 100%;
				min-height: 200px;
				padding: 0.5rem;
				margin-bottom: 1rem;
				border: 1px solid #ccc;
				border-radius: 0.25rem;
				font-family: inherit;
			}

			html.dark .modal-textarea {
				background: #2d2d2d;
				border-color: #444;
				color: #fff;
			}

			.modal-save {
				background: #3b82f6;
				color: white;
				padding: 0.5rem 1rem;
				border-radius: 0.25rem;
				border: none;
				cursor: pointer;
			}

			.modal-save:hover {
				background: #2563eb;
			}

			/* Add these styles for the new novel card structure */
			.novel-card {
				background: #fff;
				border-radius: 8px;
				overflow: hidden;
				height: 100%;
				-webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.novel-title {
				font-size: 1.125rem;
				font-weight: 600;
				margin-bottom: 0.5rem;
				overflow: hidden;
				display: -webkit-box;
				-webkit-line-clamp: 3;
				-webkit-box-orient: vertical;
			}
			.novel-title a {
				color: inherit;
				text-decoration: none;
			}
			.novel-info {
				margin-top: auto;
			}
			.author {
				font-size: 0.75rem;
				color: #666;
			}
			.chapter-info {
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-pack: justify;
				-webkit-justify-content: space-between;
				justify-content: space-between;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				margin-top: 0.5rem;
			}
			.bookmark-icon {
				width: 1rem;
				height: 1rem;
				fill: #f97316;
				margin-left: 0.25rem;
				vertical-align: middle;
			}
			.glossary-btn {
				font-size: 0.75rem;
				padding: 0.25rem 0.5rem;
				background: #3b82f6;
				color: white;
				border: none;
				border-radius: 0.25rem;
				cursor: pointer;
			}
		</style>
	</head>
	<body class="bg-gray-100">
		<div class="min-h-screen flex flex-col">
			<main class="flex-grow">
				<div class="container mx-auto px-4 py-8">
					<div class="flex justify-between items-center mb-8">
						<h1 class="text-4xl font-bold text-center">Novel Library</h1>
						<div class="flex items-center gap-4">
							<div class="flex items-center px-4 py-2 rounded-full">
								<span class="toggle-label">AI Rewrite</span>
								<label class="toggle-switch">
									<input type="checkbox" id="aiToggle" />
									<span class="toggle-slider"></span>
								</label>
							</div>
							<div class="flex items-center px-4 py-2 rounded-full">
								<span class="toggle-label">Dark Mode</span>
								<label class="toggle-switch">
									<input type="checkbox" id="darkModeToggle" />
									<span class="toggle-slider"></span>
								</label>
							</div>
							<button
								id="settingsBtn"
								class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
							>
								<i class="fas fa-cog mr-2"></i>AI Settings
							</button>
						</div>
					</div>
					<div id="loading" class="text-center text-gray-600 mb-4">
						Loading novels...
					</div>
					<div id="error" class="text-center text-red-600 mb-4 hidden"></div>
					<div id="novels">
						<!-- Novels will be loaded here -->
					</div>
				</div>
			</main>

			<!-- Footer -->
			<footer class="bg-gray-50 dark:bg-gray-900/30 mt-auto">
				<div class="container mx-auto px-4 py-4">
					<div class="text-center">
						<p class="text-gray-500 dark:text-gray-400 mb-2">
							Powered by
							<a
								href="https://orama.com"
								target="_blank"
								rel="noopener noreferrer"
								class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
								>OramaAI</a
							>
						</p>
						<p class="text-gray-500 dark:text-gray-600 mb-2">
							This website is 99% written by
							<a
								href="https://www.cursor.com/"
								target="_blank"
								rel="noopener noreferrer"
								class="text-blue-800 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
								>Cursor AI</a
							>
						</p>
						<div class="text-sm text-gray-500 dark:text-gray-400 space-y-1">
							<p>
								© 2025 Nay Tun Thein •
								<a
									href="mailto:naytunthein70@gmail.com"
									class="text-blue-800 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
									>naytunthein70@gmail.com</a
								>
							</p>
							<p>
								Novel contents are sourced from
								<a
									href="https://novelfull.com"
									target="_blank"
									rel="noopener noreferrer"
									class="text-blue-800 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
									>novelfull.com</a
								>
							</p>
							<p class="mt-2">
								<a
									href="https://github.com/naytun/rewrite-ai"
									target="_blank"
									rel="noopener noreferrer"
									class="text-blue-800 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium"
								>
									<i class="fab fa-github"></i>
									<span>GitHub</span>
								</a>
							</p>
						</div>
					</div>
				</div>
			</footer>
		</div>

		<!-- Settings Modal -->
		<div id="settingsModal" class="modal-overlay">
			<div class="modal-content">
				<div class="modal-header">
					<h2 class="text-xl font-bold">AI Settings</h2>
					<button id="closeSettingsBtn" class="modal-close">&times;</button>
				</div>
				<div>
					<label class="block mb-2">AI Rewrite Instructions</label>
					<textarea
						id="aiPrompt"
						class="modal-textarea"
						placeholder="Enter instructions for how the AI should rewrite the novel content..."
					></textarea>
				</div>
				<div style="text-align: right">
					<button id="saveSettingsBtn" class="modal-save">Save</button>
				</div>
			</div>
		</div>

		<!-- Add Glossary Modal -->
		<div
			id="glossaryModal"
			class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 overflow-hidden"
		>
			<div
				class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl max-h-[50vh] flex flex-col relative"
			>
				<!-- Header -->
				<div
					class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center shrink-0"
				>
					<h2 class="text-xl font-bold dark:text-white">Glossary</h2>
					<div class="flex gap-2">
						<button
							id="generateGlossaryBtn"
							class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors flex items-center gap-2"
						>
							<span>Generate</span>
							<i class="fas fa-spinner fa-spin hidden"></i>
						</button>
						<button
							onclick="closeGlossaryModal()"
							class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
						>
							<svg
								class="w-6 h-6"
								fill="none"
								stroke="currentColor"
								viewBox="0 0 24 24"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M6 18L18 6M6 6l12 12"
								/>
							</svg>
						</button>
					</div>
				</div>
				<!-- Scrollable Content -->
				<div id="glossaryContent" class="flex-1 overflow-y-auto p-4 min-h-0">
					<div class="text-center text-gray-500 dark:text-gray-400">
						Loading glossary...
					</div>
				</div>
			</div>
		</div>

		<script>
			// Dark mode and AI mode functionality
			const darkModeToggle = document.getElementById('darkModeToggle')
			const aiToggle = document.getElementById('aiToggle')

			// Check for saved preferences
			if (localStorage.getItem('darkMode') === 'true') {
				document.documentElement.classList.add('dark')
				darkModeToggle.checked = true
			}

			if (localStorage.getItem('aiRewrite') === 'true') {
				aiToggle.checked = true
			}

			// Toggle dark mode
			darkModeToggle.addEventListener('change', () => {
				const isDark = darkModeToggle.checked
				if (isDark) {
					document.documentElement.classList.add('dark')
					localStorage.setItem('darkMode', 'true')
				} else {
					document.documentElement.classList.remove('dark')
					localStorage.setItem('darkMode', 'false')
				}
			})

			// Toggle AI mode
			aiToggle.addEventListener('change', async () => {
				const isEnabled = aiToggle.checked
				localStorage.setItem('aiRewrite', isEnabled.toString())

				try {
					const response = await fetch('/api/settings/ai-rewrite', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							Accept: 'application/json',
						},
						body: JSON.stringify({ enabled: isEnabled }),
					})

					if (!response.ok) {
						throw new Error('Failed to update AI settings')
					}

					const result = await response.json()
					console.log('AI toggle response:', result)

					if (result.enabled !== isEnabled) {
						aiToggle.checked = result.enabled
					}

					// Reload the page to reflect the new AI state
					window.location.reload()
				} catch (error) {
					console.error('Failed to save AI preference:', error)
					// Revert the toggle if the API call fails
					aiToggle.checked = !isEnabled
					localStorage.setItem('aiRewrite', (!isEnabled).toString())
				}
			})

			function loadNovels() {
				var loadingEl = document.getElementById('loading')
				var errorEl = document.getElementById('error')
				var novelsContainer = document.getElementById('novels')

				// Clear any existing content
				while (novelsContainer.firstChild) {
					novelsContainer.removeChild(novelsContainer.firstChild)
				}

				var xhr = new XMLHttpRequest()
				xhr.open('GET', '/api/novel/novels', true)
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onload = function () {
					if (xhr.status === 200) {
						try {
							var novels = JSON.parse(xhr.responseText)
							if (!novels || novels.length === 0) {
								showError('No novels found')
								return
							}

							for (var i = 0; i < novels.length; i++) {
								createNovelCard(novels[i], novelsContainer)
							}
						} catch (error) {
							console.error('Error parsing novels:', error)
							showError('Error loading novels: ' + error.message)
						}
					} else {
						showError('Error loading novels: ' + xhr.status)
					}
					loadingEl.style.display = 'none'
				}

				xhr.onerror = function () {
					showError('Network error while loading novels')
					loadingEl.style.display = 'none'
				}

				xhr.send()
			}

			function showError(message) {
				var errorEl = document.getElementById('error')
				errorEl.textContent = message
				errorEl.style.display = 'block'
			}

			function createNovelCard(novel, container) {
				var card = document.createElement('div')
				card.className = 'novel-card'

				var lastChapter =
					localStorage.getItem('lastChapter_' + novel.id) || 'Not started'
				var coverUrl = novel.cover_url || '/placeholder.jpg'
				var authors =
					novel.authors && novel.authors.length
						? novel.authors.join(', ')
						: 'Unknown'

				var cardHtml =
					'<div class="novel-image-container">' +
					'<a href="#" class="last-chapter-link" data-novel-id="' +
					novel.id +
					'">' +
					'<img src="' +
					coverUrl +
					'" alt="Cover" onerror="this.src=\'/placeholder.jpg\'">' +
					'</a>' +
					'</div>' +
					'<div class="novel-content">' +
					'<h2 class="novel-title">' +
					'<a href="/api/novel/novels/' +
					novel.id +
					'/chapters">' +
					novel.title +
					'</a>' +
					'</h2>' +
					'<div class="novel-info">' +
					'<p class="author">Author: ' +
					authors +
					'</p>' +
					'<div class="chapter-info">' +
					'<a href="#" class="last-chapter-link" data-novel-id="' +
					novel.id +
					'">' +
					'<span>Chapter ' +
					lastChapter +
					'</span>' +
					'<svg viewBox="0 0 20 20" class="bookmark-icon"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg>' +
					'</a>' +
					'<button onclick="openGlossaryModal(\'' +
					novel.id +
					'\')" class="glossary-btn">Glossary</button>' +
					'</div>' +
					'</div>' +
					'</div>'

				card.innerHTML = cardHtml

				// Add click handlers
				var links = card.getElementsByClassName('last-chapter-link')
				for (var i = 0; i < links.length; i++) {
					links[i].onclick = function (e) {
						e.preventDefault()
						handleLastChapterClick(this.getAttribute('data-novel-id'))
					}
				}

				container.appendChild(card)
			}

			// Separate function for handling last chapter click
			async function handleLastChapterClick(novelId) {
				var lastChapter = localStorage.getItem('lastChapter_' + novelId)
				var lastVolume = localStorage.getItem('lastVolume_' + novelId)
				var url = '/api/novel/novels/' + novelId + '/chapters'

				try {
					// Get AI settings
					var aiResponse = await fetch('/api/settings/ai-rewrite', {
						headers: {
							Accept: 'application/json',
						},
					})

					var aiParam = ''
					if (aiResponse.ok) {
						var aiSettings = await aiResponse.json()
						if (aiSettings.enabled) {
							aiParam = '?useAI=true'
						}
					}

					if (lastChapter && lastVolume) {
						// Go directly to the last read chapter
						window.location.href =
							'/api/novel/novels/' +
							novelId +
							'/chapters/' +
							encodeURIComponent(lastVolume) +
							'/' +
							encodeURIComponent(lastChapter) +
							aiParam
					} else {
						// If no last read chapter, fetch first chapter info
						var response = await fetch(url)
						var data = await response.json()
						if (data.chapters && data.chapters.length > 0) {
							var firstChapter = data.chapters[0]
							window.location.href =
								'/api/novel/novels/' +
								novelId +
								'/chapters/' +
								encodeURIComponent(firstChapter.volume) +
								'/' +
								encodeURIComponent(firstChapter.chapter) +
								aiParam
						} else {
							// Fallback to chapter list if no chapters found
							window.location.href = url
						}
					}
				} catch (error) {
					console.error('Error fetching chapters:', error)
					window.location.href = url
				}
			}

			// Function to save last opened chapter
			function saveLastOpenedChapter(novelId, chapterNumber) {
				localStorage.setItem(`lastChapter_${novelId}`, chapterNumber)
			}

			// Load novels when the page loads
			window.addEventListener('load', loadNovels)

			// Settings Modal Functionality
			var settingsModal = document.getElementById('settingsModal')
			var settingsBtn = document.getElementById('settingsBtn')
			var closeSettingsBtn = document.getElementById('closeSettingsBtn')
			var saveSettingsBtn = document.getElementById('saveSettingsBtn')
			var aiPromptTextarea = document.getElementById('aiPrompt')

			// Load settings when opening modal
			settingsBtn.onclick = function () {
				settingsModal.classList.add('visible')
				loadSettings()
			}

			function loadSettings() {
				var xhr = new XMLHttpRequest()
				xhr.open('GET', '/api/settings/ai-rewrite', true)
				xhr.setRequestHeader('Accept', 'application/json')

				xhr.onload = function () {
					if (xhr.status === 200) {
						try {
							var settings = JSON.parse(xhr.responseText)
							aiPromptTextarea.value = settings.prompt || ''
							aiToggle.checked = settings.enabled
						} catch (error) {
							console.error('Error parsing settings:', error)
						}
					} else {
						console.error('Error loading settings:', xhr.status)
					}
				}

				xhr.onerror = function () {
					console.error('Error loading settings')
				}

				xhr.send()
			}

			closeSettingsBtn.onclick = function () {
				settingsModal.classList.remove('visible')
			}

			saveSettingsBtn.onclick = function () {
				var xhr = new XMLHttpRequest()
				xhr.open('POST', '/api/settings/ai-rewrite', true)
				xhr.setRequestHeader('Content-Type', 'application/json')

				xhr.onload = function () {
					if (xhr.status === 200) {
						settingsModal.classList.remove('visible')
					} else {
						console.error('Failed to save settings')
					}
				}

				xhr.onerror = function () {
					console.error('Error saving settings')
				}

				xhr.send(
					JSON.stringify({
						enabled: aiToggle.checked,
						prompt: aiPromptTextarea.value,
					})
				)
			}

			// Close modal when clicking outside
			settingsModal.onclick = function (e) {
				if (e.target === settingsModal) {
					settingsModal.classList.remove('visible')
				}
			}

			// Update the compare toggle function
			function toggleCompare() {
				const compareButton = document.getElementById('compareButton')
				const aiToggle = document.getElementById('aiToggle')
				const content = document.querySelector('.chapter-content')

				// Only allow compare when AI is enabled
				if (!aiToggle.checked) {
					alert('AI Rewrite must be enabled to use Compare mode')
					return
				}

				// Toggle the active state of the button
				const isCompareMode = compareButton.classList.contains('active')

				if (isCompareMode) {
					compareButton.classList.remove('active')
					content.classList.remove('compare-mode')
				} else {
					compareButton.classList.add('active')
					content.classList.add('compare-mode')
				}

				// Update URL without reloading
				const currentUrl = new URL(window.location.href)
				if (isCompareMode) {
					currentUrl.searchParams.delete('compare')
				} else {
					currentUrl.searchParams.set('compare', 'true')
				}
				window.history.pushState({}, '', currentUrl.toString())
			}

			// Initialize compare button state on page load
			document.addEventListener('DOMContentLoaded', () => {
				const compareButton = document.getElementById('compareButton')
				const aiToggle = document.getElementById('aiToggle')
				const content = document.querySelector('.chapter-content')
				const urlParams = new URLSearchParams(window.location.search)

				// Show compare button if AI is enabled
				if (aiToggle.checked) {
					compareButton.classList.add('show')
				}

				// Set initial compare mode state
				if (urlParams.get('compare') === 'true' && aiToggle.checked) {
					compareButton.classList.add('active')
					content.classList.add('compare-mode')
				}
			})

			// Add these new functions for glossary functionality
			let currentNovelId = null

			function openGlossaryModal(novelId) {
				currentNovelId = novelId
				const modal = document.getElementById('glossaryModal')
				modal.classList.remove('hidden')
				modal.classList.add('flex') // Add flex display when showing
				loadGlossary(novelId)

				// Set up generate button click handler
				const generateBtn = document.getElementById('generateGlossaryBtn')
				generateBtn.onclick = () => generateGlossary(novelId)
			}

			function closeGlossaryModal() {
				const modal = document.getElementById('glossaryModal')
				modal.classList.add('hidden')
				modal.classList.remove('flex') // Remove flex display when hiding
				currentNovelId = null
			}

			async function loadGlossary(novelId) {
				const contentDiv = document.getElementById('glossaryContent')
				contentDiv.innerHTML =
					'<div class="text-center text-gray-500 dark:text-gray-400 py-4">Loading glossary...</div>'

				try {
					console.log('Frontend: Loading glossary for novel:', novelId)
					const response = await fetch(`/api/novel/novels/${novelId}/glossary`)
					console.log(
						'Frontend: Glossary load response status:',
						response.status
					)

					if (!response.ok) {
						throw new Error(`Failed to load glossary: ${response.status}`)
					}

					const glossary = await response.json()
					console.log(
						'Frontend: Glossary loaded, terms count:',
						glossary?.terms?.length || 0
					)
					displayGlossary(glossary)
				} catch (error) {
					console.error('Frontend: Error loading glossary:', error)
					contentDiv.innerHTML =
						'<div class="text-center text-red-500 py-4">Failed to load glossary. The glossary might not exist yet.</div>'
				}
			}

			function displayGlossary(glossary) {
				const contentDiv = document.getElementById('glossaryContent')
				contentDiv.innerHTML = ''

				if (!glossary || !glossary.terms || glossary.terms.length === 0) {
					contentDiv.innerHTML =
						'<div class="text-center text-gray-500 dark:text-gray-400 py-4">No glossary terms available.</div>'
					return
				}

				// Sort terms alphabetically
				const sortedTerms = glossary.terms.sort((a, b) =>
					a.term.localeCompare(b.term)
				)

				// Group terms by type
				const groupedTerms = sortedTerms.reduce((acc, term) => {
					const type = term.type || 'other'
					if (!acc[type]) acc[type] = []
					acc[type].push(term)
					return acc
				}, {})

				// Create sections for each type
				const typeOrder = [
					'person',
					'location',
					'organization',
					'item',
					'technique',
					'other',
				]
				const typeLabels = {
					person: 'Characters',
					location: 'Locations',
					organization: 'Organizations',
					item: 'Items',
					technique: 'Techniques',
					other: 'Other Terms',
				}

				typeOrder.forEach((type) => {
					if (groupedTerms[type] && groupedTerms[type].length > 0) {
						const section = document.createElement('div')
						section.className = 'mb-6'
						section.innerHTML = `
							<h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">${
								typeLabels[type]
							}</h3>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-2">
								${groupedTerms[type]
									.map(
										(term) => `
									<div class="p-2 bg-gray-50 dark:bg-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer">
										<div class="font-medium text-gray-800 dark:text-gray-200">${term.term}</div>
										<div class="text-sm text-gray-600 dark:text-gray-400">${term.description}</div>
									</div>
								`
									)
									.join('')}
							</div>
						`
						contentDiv.appendChild(section)
					}
				})

				// Add last updated info
				if (glossary.lastUpdated) {
					const lastUpdated = document.createElement('div')
					lastUpdated.className =
						'text-xs text-gray-500 dark:text-gray-400 text-right mt-4'
					lastUpdated.textContent = `Last updated: ${new Date(
						glossary.lastUpdated
					).toLocaleString()}`
					contentDiv.appendChild(lastUpdated)
				}
			}

			async function generateGlossary(novelId) {
				const generateBtn = document.getElementById('generateGlossaryBtn')
				const contentDiv = document.getElementById('glossaryContent')
				const spinner = generateBtn.querySelector('.fa-spinner')
				const btnText = generateBtn.querySelector('span')

				// Show spinner and disable button before starting
				generateBtn.disabled = true
				generateBtn.classList.add('opacity-50')
				spinner.classList.remove('hidden')
				btnText.textContent = 'Generating...'

				try {
					contentDiv.innerHTML =
						'<div class="text-center text-gray-500 dark:text-gray-400 py-4">Generating glossary...</div>'

					console.log(
						'Frontend: Starting glossary generation for novel:',
						novelId
					)
					const response = await fetch(
						`/api/novel/novels/${novelId}/glossary/generate`,
						{
							method: 'POST',
							headers: {
								Accept: 'application/json',
								'Content-Type': 'application/json',
							},
						}
					)
					console.log('Frontend: Generation response status:', response.status)

					if (!response.ok) {
						const errorData = await response.json()
						console.error('Frontend: Server error details:', errorData)
						throw new Error(errorData.details || 'Failed to generate glossary')
					}

					const result = await response.json()
					console.log('Frontend: Generation successful, reloading glossary')
					await loadGlossary(novelId)
				} catch (error) {
					console.error('Frontend: Error generating glossary:', error)
					contentDiv.innerHTML =
						'<div class="text-center text-red-500 py-4">Failed to generate glossary. Please try again.</div>'
				} finally {
					// Reset button state
					generateBtn.disabled = false
					generateBtn.classList.remove('opacity-50')
					spinner.classList.add('hidden')
					btnText.textContent = 'Generate'
				}
			}

			// Close modal when clicking outside
			document
				.getElementById('glossaryModal')
				.addEventListener('click', (e) => {
					if (e.target === document.getElementById('glossaryModal')) {
						closeGlossaryModal()
					}
				})
		</script>
	</body>
</html>
